class multilineChart{constructor(t={}){var e;if(this.selector=t.selector?t.selector:"#multilineChart",this.margin=t.margin?t.margin:{top:40,bottom:30,left:50,right:100},this.fatLineWidth=t.fatLineWidth?t.fatLineWidth:3,this.needsMouseGroup=!t.needsMouseGroup||t.needsMouseGroup,this.tickNumber=t.tickNumber?t.tickNumber:4,this.hideLabel=!!t.hideLabel&&t.hideLabel,this.height=t.height?t.height:100-this.margin.top-this.margin.bottom,this.annotationSplitter=t.annotationSplitter?t.annotationSplitter:" ",this.hasConfidenceInterval=!!t.hasConfidenceInterval&&t.hasConfidenceInterval,this.xMin=!!t.xMin&&t.xMin,this.yMax=!!t.yMax&&t.yMax,this.straightLine=!!t.straightLine&&t.straightLine,1==this.hideLabel&&(this.margin.right=this.margin.left),this.data=null,this.file=t.file,this.xTickFormat=t.xTickFormat?t.xTickFormat:"d",this.timeScale=!!t.timeScale&&t.timeScale,this.exponentScale=!!t.exponentScale&&t.exponentScale,this.logScale=!!t.logScale&&t.logScale,this.annotationsDrawn=!1,this.needsFatLine=!1,this.needsDot=!1,this.dotDate=null,this.needsAnnotations=!1,this.tooltip=null,this.mouseG=null,this.mouseMoveTimeout=null,this.countries=[],this.selectedColumns=["CorÃ©e du Sud","Etats-Unis","France","Italie","Royaume-Uni","Suisse"],d3.select(this.selector).node()){this.width=parseInt(d3.select(this.selector).style("width"))-this.margin.left-this.margin.right;var a=d3.select(this.selector).append("svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom);this.g=a.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`)}else console.error("Error: element "+this.selector+" not found");this.createScales(),this.fetch()}addData(t){this.data=t;var e=this;t.forEach((function(t){e.timeScale?t.xValue=new Date(t.timestamp):t.xValue=+t.country_day}));var a=e.hasConfidenceInterval?t.columns.length-2:t.columns.length;this.countries=t.columns.slice(1,a).map((function(e){return{id:e,values:t.map((function(t){return{xValue:t.xValue,value:parseFloat(t[e])}}))}})),this.draw()}fetch(){var t=this;d3.csv(this.file).then((function(e){t.data=e,e.forEach((function(e){t.timeScale?e.xValue=new Date(e.timestamp):e.xValue=+e.country_day}));var a=t.hasConfidenceInterval?e.columns.length-2:e.columns.length;t.countries=e.columns.slice(1,a).map((function(t){return{id:t,values:e.map((function(e){return{xValue:e.xValue,value:parseFloat(e[t])}}))}})),t.draw(),t.addDot("2020-01-20")}))}createScales(){let t;var e;this.timeScale?this.xscale=d3.scaleTime().range([0,this.width]):this.xscale=d3.scaleLinear().range([0,this.width]),this.exponentScale?(console.log("Exponent scale for",this.selector),this.yscale=d3.scalePow(.5).range([this.height,0])):this.logScale?(console.log("Log scale for",this.selector),this.yscale=d3.scaleLog().range([this.height,0])):this.yscale=d3.scaleLinear().range([this.height,0]),this.zscale=d3.scaleOrdinal(d3.schemeCategory10),this.timeScale?this.xaxis=d3.axisBottom().scale(this.xscale).ticks(this.tickNumber).tickFormat(this.width>600?d3.timeFormat("%d %b"):d3.timeFormat("%d.%m")):this.xaxis=d3.axisBottom().scale(this.xscale).ticks(),this.logScale,this.yaxis=d3.axisLeft().scale(this.yscale).ticks(3).tickFormat(d3.format(this.xTickFormat)),this.g_xaxis=this.g.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")"),this.g_yaxis=this.g.append("g").attr("class","y axis"),this.g_rectlayer=this.g.append("g")}addDot(t){if(this.data){var e=this,a=this.data.filter((function(e){return e.timestamp===t}));a&&(this.g_rectlayer.selectAll(".past-rectangle").data(a).enter().append("rect").attr("class","past-rectangle").attr("x",0).attr("y",0).attr("width",(function(t,a){return e.xscale(t.xValue)})).attr("height",(function(t){return e.height})),this.g.selectAll(".dot").data(a).enter().append("circle").attr("class","dot").attr("cx",(function(t,a){return e.xscale(t.xValue)})).attr("cy",(function(t){return e.yscale(t["Nouveaux cas"])})).attr("r",5))}else this.needsDot=!0,this.dotDate=t}moveDot(t){if(this.data){var e=this,a=this.data.filter((function(e){return e.timestamp===t})),i=d3.transition().duration(300).ease(d3.easeLinear);this.g.selectAll(".dot").data(a).transition(i).attr("cx",(function(t,a){return e.xscale(t.xValue)})).attr("cy",(function(t){return e.yscale(t["Nouveaux cas"])})),this.g.selectAll(".past-rectangle").data(a).transition(i).attr("width",(function(t,a){return e.xscale(t.xValue)})).attr("height",(function(t){return e.height}))}else;}addConfidenceInterval(){console.log("Show confidence interval");var t=this;this.g.append("path").datum(this.data).attr("fill","#cce5df").attr("stroke","none").attr("d",d3.area().x((function(e){return t.xscale(e.xValue)})).y0((function(e){return t.yscale(e.min_limit)})).y1((function(e){return t.yscale(e.max_limit)})))}draw(){var t=this,e;this.timeScale?this.xscale.domain([new Date("2020-01-19"),d3.max(this.data,(function(t){return t.xValue}))]):this.xscale.domain(d3.extent(this.data,(function(t){return t.xValue}))).nice,this.logScale?this.yscale.domain([1,this.yMax?this.yMax:d3.max(this.countries,(function(t){return d3.max(t.values,(function(t){return t.value}))}))]):this.yscale.domain([t.yMin?0:d3.min(this.countries,(function(t){return d3.min(t.values,(function(t){return t.value}))})),d3.max(this.countries,(function(t){return d3.max(t.values,(function(t){return t.value}))}))]).nice(),this.zscale.domain(this.countries.map((function(t){return t.id}))),this.g_xaxis.transition().call(this.xaxis),this.g_yaxis.transition().call(this.yaxis),this.hasConfidenceInterval&&this.addConfidenceInterval(),e=this.straightLine?d3.line().x((function(e){return t.xscale(e.xValue)})).y((function(e){return t.yscale(e.value)})):d3.line().curve(d3.curveBasis).x((function(e){return t.xscale(e.xValue)})).y((function(e){return t.yscale(e.value)}));var a=this.g.selectAll(".city").data(this.countries).enter().append("g").attr("class",(function(t){return"country "+t.id}));a.append("path").attr("class","line").attr("d",(function(t){return e(t.values.filter((function(t){return-1!=t.value})))})).style("stroke",(function(e){return t.zscale(e.id)})),this.hideLabel||a.append("text").datum((function(t){for(var e=t.values.length-1;e>0&&isNaN(t.values[e].value);)e--;return{id:t.id,value:t.values[e]}})).attr("transform",(function(e){return"translate("+t.xscale(e.value.xValue)+","+t.yscale(e.value.value)+")"})).attr("x",3).attr("dy","0.35em").attr("stroke",(function(e){return"Suisse"==e.id?"#b80021":t.zscale(e.id)})).attr("class","country-label").text((function(t){return t.id})),this.needsFatLine&&this.addFatLine(),this.needsDot&&this.addDot(this.dotDate),this.needsAnnotations,this.needsMouseGroup&&(this.mouseG=this.createMouseGroup()),this.arrangeLabels()}annotate(t,e,a=0,i=-100,s="line",n=null){if(this.data||this.annotationsDrawn){var r=d3.annotationLabel,l=[{note:{title:n,label:t,wrapSplitter:this.annotationSplitter},data:{xValue:e.x,value:e.y},className:"show-bg",dx:a,dy:i,connector:{end:"arrow",type:s}}],o=d3.annotation().type(r).accessors({x:t=>this.xscale(t.xValue),y:t=>this.yscale(t.value)}).accessorsInverse({xValue:t=>this.xscale.invert(t.xValue),value:t=>this.yscale.invert(t.value)}).annotations(l);this.g.append("g").attr("class","annotation-group").call(o),this.annotationsDrawn=!0}else this.needsAnnotations=!0}arrangeLabels(){var t=this;this.g.selectAll(".country-label").each((function(){var e=this,a=this.getBoundingClientRect();t.g.selectAll(".country-label").each((function(){if(this!=e){var i=this.getBoundingClientRect(),s;if(!(a.right<i.left||a.left>i.right||a.bottom<i.top||a.top>i.bottom)){var n=e.getAttribute("y"),r=this.getAttribute("y"),l=i.top-a.top;l<10&&l>0?(e.setAttribute("y",5),this.setAttribute("y",-5)):l>-10&&l<0&&(e.setAttribute("y",-5),this.setAttribute("y",5)),"#chartDayOffset"==t.selector&&"#d62728"==e.getAttribute("stroke")&&e.setAttribute("x",60),"#chartDayOffset"==t.selector&&"#1f77b4"==e.getAttribute("stroke")&&e.setAttribute("y",10),e.setAttribute("class","country-label moved"),this.setAttribute("class","country-label moved")}}}))}))}addFatLine(){if(this.data){var t=this,e=d3.line().defined((function(t){return""!==t.Suisse})).curve(d3.curveBasis).x((function(e){return t.xscale(e.xValue)})).y((function(e){return t.yscale(e.Suisse)})),a=this.g.append("path").attr("d",e(this.data.filter((function(t){return 0!=t.Suisse})))).attr("stroke","#b80021").attr("stroke-width",this.fatLineWidth).attr("stroke-opacity",.8).attr("fill","none"),i=a.node().getTotalLength();a.attr("stroke-dasharray",i+" "+i).attr("stroke-dashoffset",i).transition().duration(3e3).ease(d3.easeCubic).attr("stroke-dashoffset",1)}else this.needsFatLine=!0}showTooltip(t){var e=this,a=[],i=!1;this.countries.forEach((function(e){isNaN(e.values[t].value)||(a.push({country:e.id,value:e.values[t].value}),i||(i=e.values[t].xValue))}));var s="";s=this.timeScale?d3.timeFormat("%d %b")(i):"Jour "+d3.format(this.xTickFormat)(i),a.sort((function(t,e){return d3.descending(t.value,e.value)}));var n=this.xscale(i)+this.margin.left+10;n>this.width-this.margin.right&&(n=this.width-this.margin.right),this.tooltip.html("<b>Semaine du "+s+"</b>").style("display","block").style("opacity",1).style("left",(function(t){return n+"px"})).selectAll().data(a).enter().append("div").html(t=>t.country+": "+t.value.toLocaleString())}createMouseGroup(){if(!this.countries||!this.zscale)return console.warn("Mouse group: data not ready yet"),!1;var t=this;this.tooltip=d3.select(this.selector).append("div").attr("class","tooltip").style("padding",6).style("left","200px").style("top","20px").html("").style("display","none");var e=this.g.append("g").attr("class","mouse-over-effects");e.append("path").attr("class","mouse-line").style("stroke","#A9A9A9").style("stroke-width","0.5pt").style("opacity",0);var a=document.getElementsByClassName("line"),i;return e.selectAll(".mouse-per-line").data(this.countries).enter().append("g").attr("class","mouse-per-line").append("circle").attr("r",4).style("stroke",(function(t){return"#ccc"})).style("fill","none").style("stroke-width","1px").style("opacity",0),e.append("svg:rect").attr("width",this.width).attr("height",this.height).attr("fill","none").attr("pointer-events","all").on("mouseout",(function(){clearTimeout(t.mouseMoveTimeout),e.select(".mouse-line").style("opacity","0"),e.selectAll(".mouse-per-line circle").style("opacity","0"),e.selectAll(".mouse-per-line text").style("opacity","0"),t.tooltip.style("display","none")})).on("mouseover",(function(){e.select(".mouse-line").style("opacity","1"),e.selectAll(".mouse-per-line circle").style("opacity","1"),t.tooltip.style("display","block")})).on("mousemove",(function(){clearTimeout(t.mouseMoveTimeout);var a=this,i=d3.mouse(this);t.mouseMoveTimeout=setTimeout((function(){var a=t.xscale.invert(i[0]),s=d3.bisector((function(t){return t.xValue})).left,n=-1;e.selectAll(".mouse-per-line").attr("transform",(function(i,r){return-1==n&&(n=s(i.values,a)),void 0!==i.values[n]?isNaN(i.values[n].value)?"":(e.select(".mouse-line").attr("d",(function(){var e="M"+t.xscale(i.values[n].xValue)+","+t.height;return e+=" "+t.xscale(i.values[n].xValue)+",0"})),"translate("+t.xscale(i.values[n].xValue)+","+t.yscale(i.values[n].value)+")"):""})),t.showTooltip(n)}),5)})),e}}